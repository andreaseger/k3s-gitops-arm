---
apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: traefik-ingress
  namespace: kube-system
  annotations:
    fluxcd.io/ignore: "false"
    fluxcd.io/automated: "false"
spec:
  releaseName: traefik-ingress
  rollback:
    enable: true
  chart:
    repository: https://helm.traefik.io/traefik
    name: traefik
    version: 9.4.3
  values:
    #
    # @CHANGEME - add proper traefik config
    # https://github.com/traefik/traefik-helm-chart/blob/master/traefik/values.yaml
    #
    deployment:
      annotations:
        linkerd.io/inject: enabled
    incressClass:
      enabled: true
      isDefaultClass: true
    persistence:
      enabled: true
      storageClass: "local-path"
    volumes:
      - name: traefik-configs
        mountPath: "/config"
        type: configMap
    additionalArguments:
      - "--providers.file.filename=/config/dynamic.yaml"
    #
    # @CHANGEME - Update loadBalancerIP to the IP traefik will use.
    # It should match a IP Address you have in range for MetalLB
    #
    # service:
    #   loadBalancerIP: 192.168.42.100
    #   externalTrafficPolicy: Local
    resources:
      requests:
        memory: 50Mi
        cpu: 100m
      limits:
        cpu: 300m
        memory: 150Mi
    env:
      - name: GANDIV5_API_KEY
        valueFrom:
          secretKeyRef:
            name: traefik-secret
            key: gandi-api-key